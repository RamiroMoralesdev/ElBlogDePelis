---
const SeriesPosts = await Astro.glob('../posts/series/*/Temporada-1/capitulo-*.md');

// Ordenar los capítulos por el campo "order" del frontmatter
const sortedPosts = SeriesPosts.sort((a, b) => a.frontmatter.order - b.frontmatter.order);
console.log(sortedPosts)

// Encontrar el índice del capítulo actual y obtener el siguiente capítulo
function getNextChapterUrl(currentIndex) {
  if (currentIndex < sortedPosts.length - 1) {
    return sortedPosts[currentIndex + 1].frontmatter.video;  // URL del siguiente capítulo
  }
  return null;  // No hay más capítulos
}

---
<html>
<head>
  
</head>
<body>
  <ul id="listPosts" class="w-10/12 h-auto text-white shadow-2xl shadow-white mx-auto flex flex-row flex-wrap justify-between items-center">
    {SeriesPosts.map((post, index) => {
      const title = post.frontmatter.title;
      const seasons = post.frontmatter.seasons;
      const description = post.frontmatter.description;
      const fecha = post.frontmatter.date;
      const video = post.frontmatter.video;
      const image = post.frontmatter.image.url;
      const nextChapterUrl = getNextChapterUrl(index);


      return ( // Mover el return aquí
        <li class="post-item">
          <img src={image} alt={title} 
               class="show-button w-56 cursor-pointer m-2" title={`${title}\n${description}`} data-index={index}>

          <dialog id={`alert-dialog-${index}`} class="w-4/5 h-full bg-[#13151a] text-white animate- ">
          <button class="text-3xl text-[#13151a] bg-emerald-500 fixed top-5 left-5 hover:text-red-500 hover:scale-150">X</button>

          <section class=" w-full h-full flex flex-row">
          
          <div class="w-6/12 flex flex-col">
          <img src={image} alt={title} width="220px" height="auto" class="max-w-[220px]">
          
          </div>

          <div class="text-balance ml-12">
            <h1 class="uppercase">{title}</h1>
            <h2>{fecha}</h2>
            <p>{description}</p>

            <div class="video-container w-full h-1/2">
              <iframe 
                id={`video-${index}`} 
                src={video} 
                class="mt-10 w-3/4 h-full" 
                allowfullscreen 
                loading="lazy"
                title={title}
              ></iframe>
            </div>

            <div>
              <a href="#" id={`btnNext-${index}`} class="btn-next" data-index={index}>Siguiente episodio</a>
            </div>

            <div>
              <p>Lista de Episodios</p>

              <div>
                <a href="#">Temporada {seasons}</a>
              </div>
            </div>

          </div>
        
        </section>
        </dialog>
      </li>
      );
    })}
  </ul>

  <style>
    dialog::backdrop {
      background: linear-gradient(#000d, #000a);
    }
  </style>

  <script>
    // Cambiar el video al hacer clic en "Siguiente episodio"
    document.querySelectorAll(".btn-next").forEach(button => {
      button.addEventListener("click", function (event) {
        event.preventDefault();
        
        const nextVideoUrl = button.getAttribute("data-next-url"); // Obtener la URL del siguiente capítulo
        const index = button.id.split('-')[1]; // Obtener el índice del episodio actual
        
        // Selecciona el iframe correspondiente al episodio actual
        const videoIframe = document.getElementById(`video-${index}`);
        
        // Si existe un siguiente capítulo, actualiza el iframe con la nueva URL
        if (nextVideoUrl) {
          videoIframe.src = nextVideoUrl;
        } else {
          alert('No hay más episodios disponibles.');
        }
      });
    });
  </script>
  
</body>
</html>